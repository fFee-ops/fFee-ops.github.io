---
title: æœåŠ¡é™çº§
date: 2020-10-21 11:59:42
tags: 
categories: Hystrix
---

<!--more-->

### æœåŠ¡é™çº§

- [8001fallback](#8001fallback_3)
- [80fallback](#80fallback_44)
- [ç›®å‰é—®é¢˜](#_81)
- - [1ã€æ¯ä¸ªä¸šåŠ¡æ–¹æ³•å¯¹åº”ä¸€ä¸ªå…œåº•çš„æ–¹æ³•ï¼Œä»£ç è†¨èƒ€](#1_82)
  - [2ã€å…œåº•çš„æ–¹æ³•å’Œä¸šåŠ¡é€»è¾‘æ··ä¸€èµ·ï¼Œæ··ä¹±](#2_140)
  - - [æµ‹è¯•](#_187)

  
**8001å…ˆä»è‡ªèº«æ‰¾é—®é¢˜ï¼šè®¾ç½®è‡ªèº«è°ƒç”¨è¶…æ—¶æ—¶é—´çš„å³°å€¼ï¼Œå³°å€¼å†…å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œè¶…è¿‡äº†éœ€è¦æœ‰å…œåº•çš„æ–¹æ³•å¤„ç†ï¼Œä½œæœåŠ¡é™çº§fallback**

# 8001fallback

**â‘ ä¸šåŠ¡ç±»å¯ç”¨**  
ä¿®æ”¹service

```java
@Service
public class PaymentService {

    //æˆåŠŸ
    public String paymentInfo_OK(Integer id){
        return "çº¿ç¨‹æ± ï¼š"+Thread.currentThread().getName()+"   paymentInfo_OK,idï¼š  "+id+"\t"+"å“ˆå“ˆå“ˆ"  ;
    }

    //å¤±è´¥
    @HystrixCommand(fallbackMethod = "paymentInfo_TimeOutHandler",commandProperties = {
            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds",value = "3000")  //3ç§’é’Ÿä»¥å†…å°±æ˜¯æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘
    })
    public String paymentInfo_TimeOut(Integer id){
        int timeNumber = 5;//è¿™é‡Œæ˜¯5sï¼Œæ‰€ä»¥è¢«è®¤ä¸ºæ˜¯è¶…æ—¶
        int x=10/0;
        try { TimeUnit.SECONDS.sleep(timeNumber); }catch (Exception e) {e.printStackTrace();}
        return "çº¿ç¨‹æ± ï¼š"+Thread.currentThread().getName()+"   paymentInfo_TimeOut,idï¼š  "+id+"\t"+"ğŸ˜­"+" è€—æ—¶(ç§’)"+timeNumber;
    }


    //å…œåº•æ–¹æ³•
    public String paymentInfo_TimeOutHandler(Integer id){
        return "çº¿ç¨‹æ± ï¼š"+Thread.currentThread().getName()+"   ç³»ç»Ÿç¹å¿™, è¯·ç¨å€™å†è¯•  ,idï¼š  "+id+"\t"+"å“­äº†å“‡å‘œ";
    }

}
```

ä¸€æ—¦è°ƒç”¨æœåŠ¡æ–¹æ³•å¤±è´¥å¹¶æŠ›å‡ºäº†é”™è¯¯ä¿¡æ¯åï¼Œä¼šè‡ªåŠ¨è°ƒç”¨\@HystrixCommandæ ‡æ³¨å¥½çš„fallbackMethodè°ƒç”¨ç±»ä¸­çš„æŒ‡å®šæ–¹æ³•

---

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/2020102111402027.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIxMDQwNTU5,size_16,color_FFFFFF,t_70#pic_center)

**â‘¡ä¸»å¯åŠ¨ç±»æ¿€æ´»**  
æ·»åŠ æ–°æ³¨è§£\@EnableCircuitBreaker

# 80fallback

80è®¢å•å¾®æœåŠ¡ï¼Œä¹Ÿå¯ä»¥æ›´å¥½çš„ä¿æŠ¤è‡ªå·±ï¼Œè‡ªå·±ä¹Ÿä¾æ ·ç”»è‘«èŠ¦è¿›è¡Œå®¢æˆ·ç«¯é™çº§ä¿æŠ¤

**â‘ æ”¹yml**

```yml
feign:
  hystrix:
    enabled: true #å¦‚æœå¤„ç†è‡ªèº«çš„å®¹é”™å°±å¼€å¯ã€‚å¼€å¯æ–¹å¼ä¸ç”Ÿäº§ç«¯ä¸ä¸€æ ·ã€‚


```

**â‘¡ä¸»å¯åŠ¨**  
\@EnableHystrix

**â‘¢ä¿®æ”¹Controller**

```java
@GetMapping("/consumer/payment/hystrix/timeout/{id}")
@HystrixCommand(fallbackMethod = "paymentTimeOutFallbackMethod",commandProperties = {
        @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds",value = "1500")  //1.5ç§’é’Ÿä»¥å†…å°±æ˜¯æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘ï¼Œä½†æ˜¯è®¾ç½®8001æ‰§è¡Œè¦3s.æ‰€ä»¥80å¿…ç„¶è‡ªæˆ‘é™çº§
})
public String paymentInfo_TimeOut(@PathVariable("id") Integer id){
    String result = paymentHystrixService.paymentInfo_TimeOut(id);
    return result;
}

//å…œåº•æ–¹æ³•
public String paymentTimeOutFallbackMethod(@PathVariable("id") Integer id){
    return "æˆ‘æ˜¯æ¶ˆè´¹è€…80ï¼Œå¯¹ä»˜æ”¯ä»˜ç³»ç»Ÿç¹å¿™è¯·10ç§’é’Ÿåå†è¯•æˆ–è€…è‡ªå·±è¿è¡Œå‡ºé”™è¯·æ£€æŸ¥è‡ªå·±,(â”¬ï¼¿â”¬)";
}
```

# ç›®å‰é—®é¢˜

## 1ã€æ¯ä¸ªä¸šåŠ¡æ–¹æ³•å¯¹åº”ä¸€ä¸ªå…œåº•çš„æ–¹æ³•ï¼Œä»£ç è†¨èƒ€

è§£å†³ï¼š

```java
@DefaultProperties(defaultFallback = "")
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201021115245419.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIxMDQwNTU5,size_16,color_FFFFFF,t_70#pic_center)

---

**ä¿®æ”¹controller**

```java
@DefaultProperties(defaultFallback = "payment_Global_FallbackMethod")  //å…¨å±€çš„
@RestController
@Slf4j
public class OrderHystrixController {

    @Resource
    private PaymentHystrixService paymentHystrixService;

    @Value("${server.port}")
    private String serverPort;

    @GetMapping("/consumer/payment/hystrix/ok/{id}")
    //è¿™ä¸ªæ–¹æ³•æ˜¯okçš„ï¼Œæ²¡æœ‰æ·»åŠ  @HystrixCommandï¼Œå°±æ˜¯ç”¨æ¥æµ‹è¯•PaymentFallbackServiceçš„fall back
    public String paymentInfo_OK(@PathVariable("id") Integer id){

        String result = paymentHystrixService.paymentInfo_OK(id);
        log.info("*******result:"+result);
        return result;
    }


//    ===============================
    @GetMapping("/consumer/payment/hystrix/timeout/{id}")

    @HystrixCommand//å¼€å¯äº†è¿™ä¸ªæ³¨è§£ï¼Œä½†æ˜¯æ²¡æœ‰æŒ‡æ˜fall backæ–¹æ³•ï¼Œå°±ä¼šç”¨å…¨å±€çš„fall backæ–¹æ³•
//    @HystrixCommand(fallbackMethod = "paymentTimeOutFallbackMethod",commandProperties = {
//            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds",value = "1500")  //1.5ç§’é’Ÿä»¥å†…å°±æ˜¯æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘,å¦‚æœè¶…è¿‡äº†å°±è¦è°ƒç”¨é™çº§æ–¹æ³•
//    })
    public String paymentInfo_TimeOut(@PathVariable("id") Integer id){
        String result = paymentHystrixService.paymentInfo_TimeOut(id);
        return result;
    }


    //å…œåº•æ–¹æ³•
    public String paymentTimeOutFallbackMethod(@PathVariable("id") Integer id){
        return "æˆ‘æ˜¯æ¶ˆè´¹è€…80ï¼Œå¯¹æ–¹æ”¯ä»˜ç³»ç»Ÿç¹å¿™è¯·10ç§’é’Ÿåå†è¯•æˆ–è€…è‡ªå·±è¿è¡Œå‡ºé”™è¯·æ£€æŸ¥è‡ªå·±,(â”¬ï¼¿â”¬)";
    }

    //ä¸‹é¢æ˜¯å…¨å±€fallbackæ–¹æ³•
    public String payment_Global_FallbackMethod(){
        return "Globalå¼‚å¸¸å¤„ç†ä¿¡æ¯ï¼Œè¯·ç¨åå†è¯•,(â”¬ï¼¿â”¬)";
    }
}
```

## 2ã€å…œåº•çš„æ–¹æ³•å’Œä¸šåŠ¡é€»è¾‘æ··ä¸€èµ·ï¼Œæ··ä¹±

1ã€ä¿®æ”¹cloud-consumer-feign-hystrix-order80

2ã€æ ¹æ®cloud-consumer-feign-hystrix-order80å·²ç»æœ‰çš„PaymentHystrixServiceæ¥å£ï¼Œé‡æ–°æ–°å»ºä¸€ä¸ªç±»ï¼ˆPaymentFallbackServiceï¼‰å®ç°è¯¥æ¥å£ï¼Œç»Ÿä¸€ä¸ºæ¥å£é‡Œé¢çš„æ–¹æ³•è¿›è¡Œå¼‚å¸¸å¤„ç†  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201021115515463.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIxMDQwNTU5,size_16,color_FFFFFF,t_70#pic_center)

```java
@Component
public class PaymentFallbackService implements PaymentHystrixService {//åªè¦ç»§æ‰¿çš„æ¥å£ä¸­çš„æ–¹æ³•å‘ç”Ÿäº†é”™è¯¯ï¼Œè¿™é‡Œå°±æ˜¯å®ƒä»¬å¯¹åº”çš„fallbackæ–¹æ³•
    @Override
    public String paymentInfo_OK(Integer id) {
        return "-----PaymentFallbackService fall back-paymentInfo_OK , (â”¬ï¼¿â”¬)";

    }

    @Override
    public String paymentInfo_TimeOut(Integer id) {
        return "-----PaymentFallbackService fall back-paymentInfo_TimeOut , (â”¬ï¼¿â”¬)";
    }
}

```

3ã€YML

```yml
feign:
  hystrix:
    enabled: true #å¦‚æœå¤„ç†è‡ªèº«çš„å®¹é”™å°±å¼€å¯ã€‚å¼€å¯æ–¹å¼ä¸ç”Ÿäº§ç«¯ä¸ä¸€æ ·ã€‚
 

```

4ã€PaymentFeignClientServiceæ¥å£

```java
@Component
@FeignClient(value = "CLOUD-PROVIDER-HYSTRIX-PAYMENT",fallback = PaymentFallbackService.class)//åªè¦è¯¥æ¥å£çš„æ–¹æ³•å‡ºé—®é¢˜äº†å°±æ‰¾PaymentFallbackService
public interface PaymentHystrixService {
    @GetMapping("/payment/hystrix/ok/{id}")
    public String paymentInfo_OK(@PathVariable("id") Integer id);

    @GetMapping("/payment/hystrix/timeout/{id}")
    public String paymentInfo_TimeOut(@PathVariable("id") Integer id);
}

```

### æµ‹è¯•

```java
    @GetMapping("/consumer/payment/hystrix/ok/{id}")
    //è¿™ä¸ªæ–¹æ³•æ˜¯okçš„ï¼Œæ²¡æœ‰æ·»åŠ  @HystrixCommandï¼Œå°±æ˜¯ç”¨æ¥æµ‹è¯•PaymentFallbackServiceçš„fall back
    public String paymentInfo_OK(@PathVariable("id") Integer id){

        String result = paymentHystrixService.paymentInfo_OK(id);
        log.info("*******result:"+result);
        return result;
    }
```

1ã€å•ä¸ªeurekaå…ˆå¯åŠ¨7001  
2ã€PaymentHystrixMain8001å¯åŠ¨  
3ã€æ­£å¸¸è®¿é—®æµ‹è¯•ï¼šhttp://localhost/consumer/payment/hystrix/ok/31  
4ã€æ•…æ„å…³é—­å¾®æœåŠ¡8001ï¼ˆæ¨¡æ‹Ÿç”Ÿäº§è€…å®•æœºï¼‰  
5ã€æ­¤æ—¶æœåŠ¡ç«¯providerå·²ç»downäº†ï¼Œä½†æ˜¯æˆ‘ä»¬åšäº†æœåŠ¡é™çº§å¤„ç†ï¼Œè®©å®¢æˆ·ç«¯åœ¨æœåŠ¡ç«¯ä¸å¯ç”¨æ—¶ä¹Ÿä¼šè·å¾—æç¤ºä¿¡æ¯è€Œä¸ä¼šæŒ‚èµ·è€—æ­»æœåŠ¡å™¨ã€‚