---
title: åˆ†å¸ƒå¼é”ä¸€æ­¥æ­¥çš„æ¨å¯¼
date: 2021-01-12 19:54:06
tags: 
categories: è¢«å¼•ç”¨
---

<!--more-->

# 2ã€çŸ¥é“åˆ†å¸ƒå¼é”å—ï¼Ÿæœ‰å“ªäº›å®ç°æ–¹æ¡ˆï¼Ÿ ä½ è°ˆè°ˆå¯¹redisåˆ†å¸ƒå¼é”çš„ç†è§£

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/2021011213542674.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIxMDQwNTU5,size_16,color_FFFFFF,t_70)

## Baseæ¡ˆä¾‹

1ã€å»ºModule  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20210112140318334.png)

2ã€æ”¹POM

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>com.sl</groupId>
    <artifactId>boot_redis01</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>boot_redis01</name>
    <description>Demo project for Spring Boot</description>

    <properties>
        <java.version>1.8</java.version>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
        <spring-boot.version>2.3.0.RELEASE</spring-boot.version>
    </properties>

    <dependencies>
        <!--é»˜è®¤æ˜¯lettuceå®¢æˆ·ç«¯-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
        <!-- redisä¾èµ–commons-pool è¿™ä¸ªä¾èµ–ä¸€å®šè¦æ·»åŠ  -->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-pool2</artifactId>
        </dependency>


        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
            <exclusions>
                <exclusion>
                    <groupId>org.junit.vintage</groupId>
                    <artifactId>junit-vintage-engine</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        <dependency>
            <groupId>com.sun.mail</groupId>
            <artifactId>jakarta.mail</artifactId>
            <version>1.6.5</version>
        </dependency>
    </dependencies>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-dependencies</artifactId>
                <version>${spring-boot.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>



        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <configuration>
                    <source>1.8</source>
                    <target>1.8</target>
                    <encoding>UTF-8</encoding>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

</project>
```

3ã€å†™YML

```yml
server:
  port: 1111

spring:
  redis:
    port: 6379
    host: 192.168.80.16
    lettuce:
      pool:
        max-active: 8 # è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
        max-idle: 8 # è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥
        min-idle: 0 # è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥
        max-wait: 1000 # è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
      shutdown-timeout: 100
    password: root


```

3ã€ä¸šåŠ¡ç±»  
**config**

```java
@Configuration
public class RedisConfig {

/**
 * ä¿è¯ä¸æ˜¯åºåˆ—åŒ–åçš„ä¹±ç é…ç½®
 */
    @Bean
    public RedisTemplate<String, Serializable> redisTemplate(LettuceConnectionFactory connectionFactory){
        RedisTemplate<String, Serializable> redisTemplate = new RedisTemplate();
        redisTemplate.setKeySerializer(new StringRedisSerializer());
        redisTemplate.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        redisTemplate.setConnectionFactory(connectionFactory);
        return redisTemplate;
    }
}
```

**controller**

```java
@RestController
public class GoodController {

    @Autowired
    private StringRedisTemplate stringRedisTemplate;

    @Value("${server.port}")
    private String serverPort;

    @GetMapping("/buy_goods")
    public String buy_Goods(){

        String result = stringRedisTemplate.opsForValue().get("goods:001");
        int goodsNumber = result == null ? 0 : Integer.parseInt(result);

        if (goodsNumber > 0){
            int realNumber = goodsNumber - 1;
            stringRedisTemplate.opsForValue().set("goods:001",realNumber + "");
            System.out.println("ä½ å·²ç»æˆåŠŸç§’æ€å•†å“ï¼Œæ­¤æ—¶è¿˜å‰©ä½™ï¼š" + realNumber + "ä»¶"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort);
            return "ä½ å·²ç»æˆåŠŸç§’æ€å•†å“ï¼Œæ­¤æ—¶è¿˜å‰©ä½™ï¼š" + realNumber + "ä»¶"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort;
        }else {
            System.out.println("å•†å“å·²ç»å”®ç½„/æ´»åŠ¨ç»“æŸ/è°ƒç”¨è¶…æ—¶ï¼Œæ¬¢è¿ä¸‹æ¬¡å…‰ä¸´"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort);
        }
        return "å•†å“å·²ç»å”®ç½„/æ´»åŠ¨ç»“æŸ/è°ƒç”¨è¶…æ—¶ï¼Œæ¬¢è¿ä¸‹æ¬¡å…‰ä¸´"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort;
    }

}

```

### V2.0

æ²¡æœ‰åŠ é”ï¼Œå¹¶å‘ä¸‹æ•°å­—ä¸å¯¹ï¼Œå‡ºç°è¶…å–ç°è±¡ï¼Œäºæ˜¯åŠ ä¸ŠğŸ”’å‡çº§åˆ°V2.0ã€‚

```java
    public String buy_Goods(){
        synchronized (this) {
            String result = stringRedisTemplate.opsForValue().get("goods:001");
            int goodsNumber = result == null ? 0 : Integer.parseInt(result);

            if (goodsNumber > 0){
                int realNumber = goodsNumber - 1;
                stringRedisTemplate.opsForValue().set("goods:001",realNumber + "");
                System.out.println("ä½ å·²ç»æˆåŠŸç§’æ€å•†å“ï¼Œæ­¤æ—¶è¿˜å‰©ä½™ï¼š" + realNumber + "ä»¶"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort);
                return "ä½ å·²ç»æˆåŠŸç§’æ€å•†å“ï¼Œæ­¤æ—¶è¿˜å‰©ä½™ï¼š" + realNumber + "ä»¶"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort;
            }else {
                System.out.println("å•†å“å·²ç»å”®ç½„/æ´»åŠ¨ç»“æŸ/è°ƒç”¨è¶…æ—¶ï¼Œæ¬¢è¿ä¸‹æ¬¡å…‰ä¸´"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort);
            }
            return "å•†å“å·²ç»å”®ç½„/æ´»åŠ¨ç»“æŸ/è°ƒç”¨è¶…æ—¶ï¼Œæ¬¢è¿ä¸‹æ¬¡å…‰ä¸´"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort;
        }
    }
```

> åœ¨å•æœºç¯å¢ƒä¸‹ï¼Œå¯ä»¥ä½¿ç”¨synchronizedæˆ–Lockæ¥å®ç°ã€‚  
> ä½†æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå› ä¸ºç«äº‰çš„çº¿ç¨‹å¯èƒ½ä¸åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Š\(åŒä¸€ä¸ªjvmä¸­ï¼‰ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªè®©æ‰€æœ‰è¿›ç¨‹éƒ½èƒ½è®¿é—®åˆ°çš„é”æ¥å®ç°ï¼Œæ¯”å¦‚redisæˆ–è€…zookeeperæ¥æ„å»º;  
> ä¸åŒè¿›ç¨‹jvmå±‚é¢çš„é”å°±ä¸ç®¡ç”¨äº†ï¼Œé‚£ä¹ˆå¯ä»¥åˆ©ç”¨ç¬¬ä¸‰æ–¹çš„ä¸€ä¸ªç»„ä»¶ï¼Œæ¥è·å–é”ï¼Œæœªè·å–åˆ°é”ï¼Œåˆ™é˜»å¡å½“å‰æƒ³è¦è¿è¡Œçš„çº¿ç¨‹

### V3.0

åˆ†å¸ƒå¼éƒ¨ç½²åï¼Œå•æœºé”è¿˜æ˜¯å‡ºç°è¶…å–ç°è±¡ï¼Œéœ€è¦åˆ†å¸ƒå¼é”ã€‚ç”¨nginxæ­å»ºä¸€ä¸‹è´Ÿè½½å‡è¡¡å’Œåå‘ä»£ç†ã€‚  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20210112181832244.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIxMDQwNTU5,size_16,color_FFFFFF,t_70)

**ç°åœ¨è®¿é—®http://192.168.80.16/buy\_goodsï¼Œå¯ä»¥ç‚¹å‡»çœ‹åˆ°æ•ˆæœï¼Œä¸€è¾¹ä¸€ä¸ªï¼Œé»˜è®¤è½®è¯¢**

---

ç°åœ¨ç”¨jmeterå‹æµ‹ä¸€ä¸‹ï¼Œå¯ä»¥å‘ç°å‡ºç°äº†è¶…å–ç°è±¡ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20210112182127271.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIxMDQwNTU5,size_16,color_FFFFFF,t_70)

---

**è§£å†³ï¼šä¸Šredisåˆ†å¸ƒå¼é”setnx**  
Rediså…·æœ‰æé«˜çš„æ€§èƒ½ï¼Œä¸”å…¶å‘½ä»¤å¯¹åˆ†å¸ƒå¼é”æ”¯æŒå‹å¥½ï¼Œå€ŸåŠ©SETå‘½ä»¤å³å¯å®ç°åŠ é”å¤„ç†.

```java

@RestController
public class GoodController {


 public static final String REDIS_LOCK_KEY = "lockhhf";

@Autowired
private StringRedisTemplate stringRedisTemplate;

@Value("${server.port}")
private String serverPort;

@GetMapping("/buy_goods")
public String buy_Goods(){

  String value = UUID.randomUUID().toString()+Thread.currentThread().getName();
//setIfAbsent() å°±æ˜¯å¦‚æœä¸å­˜åœ¨å°±æ–°å»º
Boolean lockFlag = stringRedisTemplate.opsForValue().setIfAbsent(REDIS_LOCK_KEY, value);//setnx

   if (!lockFlag) {  
return "æŠ¢é”å¤±è´¥ï¼Œâ”­â”®ï¹â”­â”®";
}else {
            String result = stringRedisTemplate.opsForValue().get("goods:001");
            int goodsNumber = result == null ? 0 : Integer.parseInt(result);

            if (goodsNumber > 0){
int realNumber = goodsNumber - 1;
stringRedisTemplate.opsForValue().set("goods:001",realNumber + "");
System.out.println("ä½ å·²ç»æˆåŠŸç§’æ€å•†å“ï¼Œæ­¤æ—¶è¿˜å‰©ä½™ï¼š" + realNumber + "ä»¶"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort);
 stringRedisTemplate.delete(REDIS_LOCK_KEY);//é‡Šæ”¾é”
return "ä½ å·²ç»æˆåŠŸç§’æ€å•†å“ï¼Œæ­¤æ—¶è¿˜å‰©ä½™ï¼š" + realNumber + "ä»¶"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort;
}else {
                System.out.println("å•†å“å·²ç»å”®ç½„/æ´»åŠ¨ç»“æŸ/è°ƒç”¨è¶…æ—¶ï¼Œæ¬¢è¿ä¸‹æ¬¡å…‰ä¸´"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort);
}
return "å•†å“å·²ç»å”®ç½„/æ´»åŠ¨ç»“æŸ/è°ƒç”¨è¶…æ—¶ï¼Œæ¬¢è¿ä¸‹æ¬¡å…‰ä¸´"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort;
}
    }
}

```

### V4.0

V3.0çš„é—®é¢˜ï¼šå‡ºå¼‚å¸¸çš„è¯ï¼Œå¯èƒ½æ— æ³•é‡Šæ”¾é”ï¼Œ å¿…é¡»è¦åœ¨ä»£ç å±‚é¢finallyé‡Šæ”¾é”

```java
    @GetMapping("/buy_goods")
    public String buy_Goods(){

        String value = UUID.randomUUID().toString()+Thread.currentThread().getName();
        try {
//setIfAbsent() å°±æ˜¯å¦‚æœä¸å­˜åœ¨å°±æ–°å»º
            Boolean lockFlag = stringRedisTemplate.opsForValue().setIfAbsent(REDIS_LOCK_KEY, value);//setnx

            if (!lockFlag) {
                return "æŠ¢é”å¤±è´¥ï¼Œâ”­â”®ï¹â”­â”®";
            }else {
                String result = stringRedisTemplate.opsForValue().get("goods:001");
                int goodsNumber = result == null ? 0 : Integer.parseInt(result);

                if (goodsNumber > 0){
                    int realNumber = goodsNumber - 1;
                    stringRedisTemplate.opsForValue().set("goods:001",realNumber + "");
                    System.out.println("ä½ å·²ç»æˆåŠŸç§’æ€å•†å“ï¼Œæ­¤æ—¶è¿˜å‰©ä½™ï¼š" + realNumber + "ä»¶"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort);
                    stringRedisTemplate.delete(REDIS_LOCK_KEY);//é‡Šæ”¾é”
                    return "ä½ å·²ç»æˆåŠŸç§’æ€å•†å“ï¼Œæ­¤æ—¶è¿˜å‰©ä½™ï¼š" + realNumber + "ä»¶"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort;
                }else {
                    System.out.println("å•†å“å·²ç»å”®ç½„/æ´»åŠ¨ç»“æŸ/è°ƒç”¨è¶…æ—¶ï¼Œæ¬¢è¿ä¸‹æ¬¡å…‰ä¸´"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort);
                }
                return "å•†å“å·²ç»å”®ç½„/æ´»åŠ¨ç»“æŸ/è°ƒç”¨è¶…æ—¶ï¼Œæ¬¢è¿ä¸‹æ¬¡å…‰ä¸´"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort;
            }
        } finally {
                stringRedisTemplate.delete(REDIS_LOCK_KEY);//é‡Šæ”¾é”
        }
    }
```

### V5.0

V4.0é—®é¢˜ï¼šéƒ¨ç½²äº†å¾®æœåŠ¡jaråŒ…çš„æœºå™¨æŒ‚äº†ï¼Œä»£ç å±‚é¢æ ¹æœ¬æ²¡æœ‰èµ°åˆ°finallyè¿™å—ï¼Œ æ²¡åŠæ³•ä¿è¯è§£é”ï¼Œè¿™ä¸ªkeyæ²¡æœ‰è¢«åˆ é™¤ï¼Œéœ€è¦åŠ å…¥ä¸€ä¸ªè¿‡æœŸæ—¶é—´é™å®škey

**è§£å†³ï¼šéœ€è¦å¯¹lockKeyæœ‰è¿‡æœŸæ—¶é—´çš„è®¾å®š**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/2021011218315429.png)

### V6.0

V5.0é—®é¢˜ï¼šè®¾ç½®key+è¿‡æœŸæ—¶é—´åˆ†å¼€äº†ï¼Œå¿…é¡»è¦åˆå¹¶æˆä¸€è¡Œå…·å¤‡åŸå­æ€§

**è§£å†³ï¼šå°†è®¾ç½®key+è¿‡æœŸæ—¶é—´å’Œä¸ºä¸€è¡Œ**

```java
 //setIfAbsent() == setnx å°±æ˜¯å¦‚æœä¸å­˜åœ¨å°±æ–°å»ºï¼ŒåŒæ—¶åŠ ä¸Šè¿‡æœŸæ—¶é—´ä¿è¯åŸå­æ€§
 Boolean lockFlag = stringRedisTemplate.opsForValue().setIfAbsent(REDIS_LOCK_KEY, value,10L, TimeUnit.SECONDS);
```

### V7.0

V6.0çš„é—®é¢˜ï¼šå¯èƒ½ä¼šå¼ å† ææˆ´ï¼Œåˆ é™¤äº†åˆ«äººçš„é”ã€‚

> æ¯”å¦‚Açº¿ç¨‹è¿›æ¥ï¼Œæ‹¿åˆ°é”ï¼Œé”çš„æœ‰æ•ˆæœŸä¸º10sï¼Œä½†æ˜¯Aæ“ä½œäº†12Sï¼Œåˆ°ç¬¬10Sçš„æ—¶å€™è¿™ä¸ªé”ä¼šè¢«è‡ªåŠ¨åˆ é™¤ï¼ŒBä¸€çœ‹æ²¡é”äº†ï¼Œä¹Ÿè¿›æ¥äº†ï¼ŒAæ“ä½œå®Œäº†ï¼Œä¸€çœ‹è¿˜æœ‰ä¸€æŠŠé”ï¼Œå°±ç»™å®ƒåˆ é™¤äº†ã€‚å…¶å®è¿™æ˜¯Bçš„é”ã€‚

**è§£å†³ï¼šç¡®ä¿æ¥è§£é”çš„çº¿ç¨‹å°±æ˜¯æŒæœ‰è¿™ä¸ªé”çš„çº¿ç¨‹**  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20210112192622416.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20210112192413914.png)

### V8.0

V7.0çš„é—®é¢˜ï¼šfinallyå—çš„åˆ¤æ–­+delåˆ é™¤æ“ä½œä¸æ˜¯åŸå­æ€§çš„  
**è§£å†³ï¼š**  
â‘ ç”¨redisè‡ªèº«çš„äº‹åŠ¡ï¼šå¤§ä½“æ€è·¯å°±æ˜¯ç”¨WATCHç›‘è§†é”ï¼Œç„¶åå¼€å¯äº‹åŠ¡ï¼Œå»åˆ é™¤é”ï¼Œå¦‚æœæˆåŠŸå°±UNWATCHã€‚å¦åˆ™ä¼šä¸€ç›´å°è¯•ã€‚  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20210112192757846.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIxMDQwNTU5,size_16,color_FFFFFF,t_70)

```java
finally {
            while (true)
            {
                stringRedisTemplate.watch(REDIS_LOCK_KEY); //åŠ äº‹åŠ¡ï¼Œä¹è§‚é”
                if (value.equalsIgnoreCase(stringRedisTemplate.opsForValue().get(REDIS_LOCK_KEY))){
                    stringRedisTemplate.setEnableTransactionSupport(true);
                    stringRedisTemplate.multi();//å¼€å§‹äº‹åŠ¡
                    stringRedisTemplate.delete(REDIS_LOCK_KEY);
                    List list = stringRedisTemplate.exec();
                    if (list == null) {  //å¦‚æœç­‰äºnullï¼Œå°±æ˜¯æ²¡æœ‰åˆ æ‰ï¼Œåˆ é™¤å¤±è´¥ï¼Œå†å›å»whileå¾ªç¯é‚£å†é‡æ–°æ‰§è¡Œåˆ é™¤
                        continue;
                    }
                }
                //å¦‚æœåˆ é™¤æˆåŠŸï¼Œé‡Šæ”¾ç›‘æ§å™¨ï¼Œå¹¶ä¸”breankè·³å‡ºå½“å‰å¾ªç¯
                stringRedisTemplate.unwatch();
                break;
            }
        }
```

â‘¡ç”¨luaè„šæœ¬

### V9.0

â‘ è¦è§£å†³Redisåˆ†å¸ƒå¼é”ç»­æœŸçš„é—®é¢˜ã€‚  
â‘¡Redisé›†ç¾¤+CAPå¯¹æ¯”zookeeperï¼š  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20210112193448194.png)

### V10.0

ç»¼åˆä¸Šè¿°ã€‚redisé›†ç¾¤ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬è‡ªå·±å†™çš„ä¹Ÿä¸OK, ç›´æ¥ä¸ŠRedLockä¹‹Redissonè½åœ°å®ç°ã€‚  
**Config**

```java
import org.redisson.Redisson;
import org.redisson.Config;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.StringRedisSerializer;

import java.io.Serializable;

/**
 * ä¿è¯ä¸æ˜¯åºåˆ—åŒ–åçš„ä¹±ç é…ç½®
 */
@Configuration
public class RedisConfig {

    @Value("${spring.redis.host}")
    private String redisHost;

    @Bean
    public RedisTemplate<String, Serializable> redisTemplate(LettuceConnectionFactory connectionFactory){
        RedisTemplate<String, Serializable> redisTemplate = new RedisTemplate();
        redisTemplate.setKeySerializer(new StringRedisSerializer());
        redisTemplate.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        redisTemplate.setConnectionFactory(connectionFactory);
        return redisTemplate;
    }

    @Bean
    public Redisson redisson(){
        Config config = new Config();
        config.useSingleServer().setAddress(redisHost+":6379").setDatabase(0).setPassword("root");
        return (Redisson) Redisson.create(config);
    }
}


```

**Controller**

```java
@RestController
public class GoodController {


public static final String REDIS_LOCK_KEY = "lockhhf";

@Autowired
private StringRedisTemplate stringRedisTemplate;

@Value("${server.port}")
private String serverPort;

@Autowired
private Redisson redisson;

@GetMapping("/buy_goods")
public String buy_Goods(){

        String value = UUID.randomUUID().toString()+Thread.currentThread().getName();

RLock redissonLock = redisson.getLock(REDIS_LOCK_KEY);
redissonLock.lock();
        try{
                String result = stringRedisTemplate.opsForValue().get("goods:001");
                int goodsNumber = result == null ? 0 : Integer.parseInt(result);

                if (goodsNumber > 0){
int realNumber = goodsNumber - 1;
stringRedisTemplate.opsForValue().set("goods:001",realNumber + "");
System.out.println("ä½ å·²ç»æˆåŠŸç§’æ€å•†å“ï¼Œæ­¤æ—¶è¿˜å‰©ä½™ï¼š" + realNumber + "ä»¶"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort);
                    return "ä½ å·²ç»æˆåŠŸç§’æ€å•†å“ï¼Œæ­¤æ—¶è¿˜å‰©ä½™ï¼š" + realNumber + "ä»¶"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort;
}else {
                    System.out.println("å•†å“å·²ç»å”®ç½„/æ´»åŠ¨ç»“æŸ/è°ƒç”¨è¶…æ—¶ï¼Œæ¬¢è¿ä¸‹æ¬¡å…‰ä¸´"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort);
}
return "å•†å“å·²ç»å”®ç½„/æ´»åŠ¨ç»“æŸ/è°ƒç”¨è¶…æ—¶ï¼Œæ¬¢è¿ä¸‹æ¬¡å…‰ä¸´"+"\t æœåŠ¡å™¨ç«¯å£: "+serverPort;

}finally {
            redissonLock.unlock();
}
    }
}
```

### V11.0

V10.0çš„Bugï¼šæ˜¯åœ¨å¹¶å‘å¤šçš„æ—¶å€™å°±å¯èƒ½ä¼šé‡åˆ°è¿™ç§é”™è¯¯ï¼Œå¯èƒ½ä¼šè¢«é‡æ–°æŠ¢å   
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20210112194554863.png)  
**è§£å†³ï¼š**  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20210112194648823.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIxMDQwNTU5,size_16,color_FFFFFF,t_70)

## æ€»ç»“

æœ€å¼€å§‹æ²¡åŠ é”ï¼Œä¸ok  
â†“  
synchronized å•æœºç‰ˆoKï¼Œä¸Šåˆ†å¸ƒå¼  
â†“  
nginxåˆ†å¸ƒå¼å¾®æœåŠ¡ å•æœºé”ä¸è¡Œ  
â†“  
å–æ¶ˆå•æœºé” ä¸Šredisåˆ†å¸ƒå¼é”setnx  
â†“  
åªåŠ äº†é”ï¼Œæ²¡æœ‰é‡Šæ”¾é”ï¼Œ å‡ºå¼‚å¸¸çš„è¯ï¼Œå¯èƒ½æ— æ³•é‡Šæ”¾é”ï¼Œ å¿…é¡»è¦åœ¨ä»£ç å±‚é¢finallyé‡Šæ”¾é”  
â†“  
å®•æœºäº†ï¼Œéƒ¨ç½²äº†å¾®æœåŠ¡ä»£ç å±‚é¢æ ¹æœ¬æ²¡æœ‰èµ°åˆ°finallyè¿™å—ï¼Œ  
æ²¡åŠæ³•ä¿è¯è§£é”ï¼Œè¿™ä¸ªkeyæ²¡æœ‰è¢«åˆ é™¤ï¼Œéœ€è¦æœ‰lockKeyçš„è¿‡æœŸæ—¶é—´è®¾å®š  
â†“  
ä¸ºredisçš„åˆ†å¸ƒå¼é”keyï¼Œå¢åŠ è¿‡æœŸæ—¶é—´ã€‚  
æ­¤å¤–ï¼Œè¿˜å¿…é¡»è¦setnx+è¿‡æœŸæ—¶é—´å¿…é¡»åŒä¸€è¡Œçš„åŸå­æ€§æ“ä½œ  
â†“  
å¿…é¡»è§„å®šåªèƒ½è‡ªå·±åˆ é™¤è‡ªå·±çš„é”ï¼Œä½ ä¸èƒ½æŠŠåˆ«äººçš„é”åˆ é™¤äº†,é˜²æ­¢å¼ å† ææˆ´ï¼Œ1åˆ 2çš„é”,2åˆ 3çš„ã€‚  
â†“  
ä¸ºäº†è§£å†³ä¸Šä¸€æ­¥çš„é—®é¢˜ï¼Œåœ¨finallyå—ä¸­åŠ äº†ä¸€ä¸ªifåˆ¤æ–­å†è¿›è¡Œåˆ é™¤ï¼Œä½†æ˜¯ifå’Œdelä¸æ˜¯åŸå­æ€§çš„ã€‚æ‰€ä»¥ç”¨luaæˆ–è€…äº‹åŠ¡æ¥ä¿è¯åŸå­æ€§  
â†“  
redisé›†ç¾¤ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬è‡ªå·±å†™çš„ä¹Ÿä¸OKã€‚  
ç›´æ¥ä¸ŠRedLockä¹‹Redissonè½åœ°å®ç°