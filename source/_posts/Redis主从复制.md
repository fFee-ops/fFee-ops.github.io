---
title: Redis主从复制
date: 2020-09-08 16:35:55
tags: redis 数据库 运维
categories: Redis
---

<!--more-->

### Redis主从复制

- [为什么要提出主从复制](#_2)
- - [如何提升系统的并发能力](#_10)
- [主从复制](#_20)
- - [简介](#_23)
  - [原理](#_34)

# 为什么要提出主从复制

单点Redis容易出现以下问题  
①、从结构上，单个Redis服务器会发生单点故障，并且一台服务器需要处理所有的请求负载，压力较大； \(容错性\)

②、从容量上，单个Redis服务器内存容量有限，就算一台Redis服务器内容容量为256G，也不能将所有内容用作Redis存储内存，一般来说，单台Redis最大使用内存不应该超过20G。

## 如何提升系统的并发能力

①**垂直扩展（Scale Up）**  
垂直扩展就是提升单机处理能力。例如增强单机硬件性能（增加CPU核数等）、提升单机架构性能（使用Cache来减少IO次数等）。

②**水平扩展（Scale Out）**  
只要增加服务器数量，就能线性扩充系统性能。水平扩展对系统架构设计是有要求的，难点在于如何在架构各层进行可水平扩展的设计。

# 主从复制

也就是针对提高系统的并发能力采取了水平扩展的办法：主从复制。

## 简介

一个Redis服务可以有多个该服务的复制品，这个Redis服务称为Master，其它复制称为Slaves  
![在这里插入图片描述](https://img-blog.csdnimg.cn/2020090816270327.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIxMDQwNTU5,size_16,color_FFFFFF,t_70#pic_center)

如图中所示，将一台Redis服务器作主库\(Matser\)，其他三台作为从库\(Slave\)，**主库只负责写数据**，每次有数据更新都将更新的数据同步到它所有的从库，而**从库只负责读数据**。这样一来，就有了两个好处：

1.  读写分离，不仅可以提高服务器的负载能力，还可以根据读请求的规模自由增加或者减少从库的数量。
2.  数据被复制成了了好几份，就算有一台机器出现故障，也可以使用其他机器的数据快速恢复。

需要注意的是：在Redis主从模式中，一台主库可以拥有多个从库，但是一个从库只能隶属于一个主库。

## 原理

**slaveof**：  
在Redis中可以使用slaveof命令让一个Redis实例去复制另一个Redis实例的内容。这里需要注意当A实例执行该命令去复制B实例的内容后，以前A实例的内容都将被B实例的内容覆盖。同时在从服务器将被设置为只读，向从服务器发送写命令时，将被拒绝。

当从服务器发起slaveof命令后，主从服务器之间通过TCP长连接进行通信，主要是以下步骤：  
![在这里插入图片描述](https://img-blog.csdnimg.cn/0d9b5bbc03dd4dde8cd831da5f535410.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAZkZlZS1vcHM=,size_20,color_FFFFFF,t_70,g_se,x_16)  
第一次完整的主从同步就完成了。然后主从之间会维持TCP连接，每次master收到新的写命令后，都会发给从服务器。

如果期间连接断了，当从服务器重新连上主服务器后，上述的步骤会重新来一遍。可以发现这是很低效的

**注意：从服务器在加载RDB文件过程中是阻塞的，无法处理客户端的请求。**

---

基于上述原因（特别是断线时间特别短时），Redis推出了新的同步命令`psync`。  
psync将同步过程分为了两块：1、完整同步；2、部分同步。  
**完整同步**也叫初次同步，也就是第一次主从同步。步骤跟v1上述是一致的。

**部分同步**主要用户断线重连后的同步，它可以将断线期间的写入命令发送给从服务器，而不需要整个RDB文件，极大的节约了资源。当从服务器重新连接了主服务器后，会发送psync命令，然后主服务器回复continue命令，并且发送缺少的写入命令到从服务器。

**部分同步原理：**  
redis完成部分同步功能主要依赖于以下部分：  
1、主服务器的复制偏移量  
2、从服务器的复制偏移量  
3、命令缓存区（FIFO队列，默认大小1MB）  
4、服务器运行Id  
每次主服务器向从服务器传递N个字节命令后，就在把自己的偏移量+N。从服务器同理。同时主服务器还会将命令写入到命令缓存区里。当从服务器重连时发生如下步骤：

![在这里插入图片描述](https://img-blog.csdnimg.cn/2b62374aff9f49c294d1ef401bda4cab.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAZkZlZS1vcHM=,size_20,color_FFFFFF,t_70,g_se,x_16)

> 每个Redis都有自己的唯一标识Id。在启动时自动生成，由40个随机的十六进制字符组成。当发送第一次主从同步时，master会将自己的id发送会从服务器，从服务器会将其保存起来。断线重连时，从服务器请求同步时还会将这个id发送给主服务器，主服务器判断该id与自己的id是否一致，如果一致则继续执行部分同步的剩余步骤。否则执行完整同步。